<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.thenet.fapee.my.service.impl.MyMapper">

	<select id="selectMyProfileInfo" resultType="egovMap">
		SELECT u.idKey
			  ,u.userId
			  ,u.userType
			  ,u.status
			  ,uf.gender
			  ,uf.country
			  ,(SELECT COUNT(*) 
		 		  FROM fp_follow 
		 		 WHERE followUserIdKey = #{_parameter}) followerCount
		 	  ,(SELECT COUNT(*) 
		 		  FROM fp_follow 
		 		 WHERE userIdKey = #{_parameter}) followingCount
			  ,up.nickName
			  ,up.content
			  ,up.imageUrl
		 FROM fp_user u
		 JOIN fp_user_filter uf on u.idKey = uf.userIdKey
		 JOIN fp_user_profile up on u.idKey = up.userIdKey
		WHERE u.idkey = #{_parameter}
	</select>

	<select id="selectUserModelInfo" resultType="egovMap">
		SELECT  model.idKey
		       ,model.imgUrl
		       ,model.modelName
		FROM fp_user_model_map map
	    JOIN fp_user_model model on map.modelKey = model.idKey
		WHERE map.uerKey =#{_parameter}
		AND map.useYn ='Y'
		ORDER BY model.seq
	</select>

	<update id="updateUserModelMap" parameterType="egovMap" >
		UPDATE fp_user_model_map map
		<trim prefix="SET" suffixOverrides=",">
			<if test="useYn != null">map.useYn=#{useYn},</if>
		</trim>
		WHERE map.idKey = #{modelKey}
	</update>
	
	<update id="updateMyProfileInfo" parameterType="egovMap" >
		UPDATE fp_user_profile
		<trim prefix="SET" suffixOverrides=",">
			<if test="nickName != null">nickName=#{nickName},</if>
			<if test="content != null">content=#{content},</if>
			<if test="imageUrl != null">imageUrl = #{imageUrl},</if>
		</trim>
		 WHERE userIdKey = #{idKey}
	</update>
	
	<select id="selectMyFollowingCount" parameterType="egovMap" resultType="int">
		SELECT count(*)
  		  FROM fp_follow
 		 WHERE userIdKey = #{userIdKey} AND followUserIdKey = #{followUserIdKey}
	</select>
	
	<insert id="insertMyFollwInfo" parameterType="egovMap">
		INSERT into fp_follow(
			 userIdKey
			,followUserIdKey
			,followDate
		) VALUES (
			 #{userIdKey}
			,#{followUserIdKey}
			,now()
		)
	</insert>
	
	<delete id="deleteMyFollwInfo" parameterType="egovMap">
		DELETE FROM fp_follow
         WHERE userIdKey = #{userIdKey} AND followUserIdKey = #{followUserIdKey}
	</delete>
	
	<select id="selectMyFollowList" parameterType="egovMap" resultType="egovMap">
		SELECT f.userIdKey
			  ,f.followUserIdKey
		      ,u.userId
		      ,up.imageUrl
		      <if test='sessionIdKey != null'>
		      ,(
				 SELECT count(*)
		  		   FROM fp_follow
		 		  WHERE userIdKey = #{sessionIdKey} 
		 		  <choose>
		 		  	<when test='type == "fwers"'>
		 		  		AND followUserIdKey = u.idKey
		 		  	</when>
		 		  	<when test='type == "fwing"'>
		 		  		AND followUserIdKey = f.followUserIdKey
		 		  	</when>
		 		  </choose>
			   ) isFollow
		      </if>
		  FROM fp_follow f
		  LEFT JOIN fp_user u ON <choose>
		 		 				 	<when test='type == "fwers"'>
		 		  						f.userIdKey = u.idKey
		 		  					</when>
		 		  					<when test='type == "fwing"'>
		 		  						f.followUserIdKey = u.idKey
		 		  					</when>
		 		 				 </choose>
		  LEFT JOIN fp_user_profile up ON u.idKey = up.userIdKey
		 WHERE 1=1 <if test="searchId != ''">
		 		   		AND u.userId LIKE CONCAT('%', #{searchId},'%')
		 		   </if>
		 		
		 		   <choose>
		 			<when test='type == "fwers"'>
		 		  		AND f.followUserIdKey = #{idKey}
		 		  	</when>
		 		  	<when test='type == "fwing"'>
		 		  		AND f.userIdKey = #{idKey}
		 		  	</when>
		 		  </choose>
		 ORDER BY f.followDate desc
		 <if test="pageStart != null and pageSize != null">
		 	LIMIT #{pageStart}, #{pageSize}
		 </if>
	</select>
	
	<select id="selectMyFollowCount" resultType="egovMap" parameterType="egovMap">
		SELECT (SELECT COUNT(*) 
		 		  FROM fp_follow f
		 		  JOIN fp_user u ON f.userIdKey = u.idKey
		 		 WHERE followUserIdKey = #{idKey}
			 			<if test="searchId != ''">
			 		   		AND u.userId LIKE CONCAT('%', #{searchId},'%')
			 		   </if> 
		 		 
		 	   ) followerCount
		 	  ,(SELECT COUNT(*) 
		 		  FROM fp_follow f
		 		  JOIN fp_user u ON f.followUserIdKey = u.idKey
		 		 WHERE userIdKey = #{idKey}
			 			<if test="searchId != ''">
			 		   		AND u.userId LIKE CONCAT('%', #{searchId},'%')
			 		   </if>  
		 	   ) followingCount
	</select>
	
</mapper>