<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.thenet.fapee.look.service.impl.LookMapper">

	<select id="selectLookStyleList" resultType="egovMap">
		SELECT  idKey
			  , seq
			  , style
		  FROM fp_style
		 ORDER BY seq
	</select>
	<select id="selectLookAllList" resultType="egovMap">
		SELECT l.idKey
			, u.userId
			, s.style
			, l.content
			, l.createdate
			, l.status
		FROM fp_look as l
		LEFT JOIN fp_user as u ON l.userIdKey = u.idKey
		LEFT JOIN fp_style as s ON l.styleIdKey = s.idKey
		ORDER BY idKey
	</select>
	<insert id="insertLook" parameterType="LookVO" useGeneratedKeys="true" keyProperty="idKey">
		INSERT INTO fp_look (
			userIdKey
			,styleIdKey
			,content
			,createDate
			,status
		) VALUES (
			#{userIdKey}
			,#{styleIdKey}
			,#{content}
			,now()
			,1
		)
	</insert>
	
	<insert id="insertLookImage" parameterType="LookVO">
		INSERT INTO fp_look_image (
			lookIdKey
			,imageUrl
		) VALUES
		<foreach collection="images" item="image" separator=","> 
		(
			"${idKey}"
			,"${image}"
		)
		</foreach>
	</insert>
	
	<insert id="insertLookTags" parameterType="LookVO">
		INSERT INTO fp_look_tag (
			lookIdKey
			,tagName
		) VALUES
		<foreach collection="tags" item="tag" separator=","> 
		(
			"${idKey}"
			,"${tag}"
		)
		</foreach>
	</insert>
	
	<select id="selectLookProfileList" resultType="egovMap">
		SELECT u.idKey
			  ,u.userId
			  ,l.idKey AS lookIdkey
			  ,l.content
			  ,s.style
			  ,up.nickName
			  ,up.imageUrl
			  ,uf.gender
			  ,uf.country
			  ,1 AS coolCount
			  ,1 AS commentCount
			  ,(SELECT GROUP_CONCAT(imageUrl ORDER BY idKey SEPARATOR ',,,')
				  FROM fp_look_image
				  WHERE lookIdKey = l.idKey
				  GROUP BY lookIdKey) AS image
			  ,(SELECT GROUP_CONCAT(tagName ORDER BY idKey SEPARATOR ',,,')
				  FROM fp_look_tag
				  WHERE lookIdKey = l.idKey
				  GROUP BY lookIdKey) AS tag
		  FROM fp_user u
		  JOIN fp_user_filter uf ON u.idKey = uf.userIdKey
		  JOIN fp_user_profile up ON u.idKey = up.userIdKey
		  JOIN fp_look l ON u.idKey = l.userIdKey 
		  JOIN fp_style s ON l.styleIdKey = s.idKey
		 WHERE u.idKey = #{idKey}
		 ORDER BY l.createDate DESC
		 <if test="pageStart != null and pageSize != null">
		 	LIMIT #{pageStart}, #{pageSize}
		 </if>
	</select>
	
</mapper>